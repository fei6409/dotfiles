#!/bin/bash

DIRECTION="-L"
JUMP_HOST=""
LISTEN_PORT=""
TARGET_HOST=""
TARGET_PORT=""
KILL_PORT=""

usage() {
  echo "Usage: $0 [-R] -j jump_host -p target_port [-l listen_port] [-t target_host]"
  echo "       $0 -k listen_port"
  echo ""
  echo "Options:"
  echo "  -j: Jump Host   (The SSH server)"
  echo "  -p: Target Port (The destination port)"
  echo "  -t: Target Host (The destination address. Default: localhost)"
  echo "  -l: Listen Port (The port opening the tunnel. Default: target_port)"
  echo "  -R: Reverse tunnel (Listen on Jump Host instead of Local)"
  echo "  -k: Kill tunnel by listen port"
  exit 1
}

# Parse options
while getopts ":j:p:t:l:k:R" opt; do
  case ${opt} in
    j) JUMP_HOST=$OPTARG ;;
    p) TARGET_PORT=$OPTARG ;;
    t) TARGET_HOST=$OPTARG ;;
    l) LISTEN_PORT=$OPTARG ;;
    k) KILL_PORT=$OPTARG ;;
    R) DIRECTION="-R" ;;
    *) usage ;;
  esac
done

shift $((OPTIND - 1))

# Kill logic
if [[ -n "$KILL_PORT" ]]; then
  if ! command -v lsof &> /dev/null; then
    echo "Error: 'lsof' is required to kill a process by port." >&2
    exit 1
  fi
  PIDS=$(lsof -i TCP:"$KILL_PORT" -s TCP:LISTEN -t)
  if [[ -n "$PIDS" ]]; then
    # shellcheck disable=SC2086
    if kill $PIDS; then
      echo "Killed process(es) on port $KILL_PORT (PIDs: $(echo $PIDS | xargs))."
    else
      echo "Failed to kill process(es) on port $KILL_PORT." >&2
      exit 1
    fi
  else
    echo "No tunnel found on port $KILL_PORT."
  fi
  exit 0
fi

# Validation
[[ -z "$JUMP_HOST" || -z "$TARGET_PORT" ]] && usage

# Apply defaults
TARGET_HOST=${TARGET_HOST:-localhost}
LISTEN_PORT=${LISTEN_PORT:-$TARGET_PORT}

# Display Context
if [[ "$DIRECTION" == "-R" ]]; then
  echo "[Reverse] Listening on $JUMP_HOST:$LISTEN_PORT -> Targeting $TARGET_HOST:$TARGET_PORT"
else
  echo "[Local] Listening on localhost:$LISTEN_PORT -> Targeting $TARGET_HOST:$TARGET_PORT via $JUMP_HOST"
fi

# Execution
echo "  (ssh -fN $DIRECTION $LISTEN_PORT:$TARGET_HOST:$TARGET_PORT $JUMP_HOST)"
ssh -fN "$DIRECTION" "$LISTEN_PORT:$TARGET_HOST:$TARGET_PORT" "$JUMP_HOST"
